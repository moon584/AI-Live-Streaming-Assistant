# 小聚AI助手（乡聚助农）

主要功能

1. 会话管理：创建、查询和管理直播会话及其下的商品信息。
2. 智能话术生成：根据商品类型与已知属性自动生成直播话术建议。
3. FAQ 与问答缓存：优先命中白名单答案并缓存常见问答以提升响应速度。
4. 弹幕收集：接收与管理直播弹幕，支持检索与标记处理。
5. 可选 TTS：对接百度 TTS 输出语音（需在环境变量中配置 Key）。

（更多使用和部署说明请参见仓库内其它文档或向开发者索取详细指南。）

---

快速上手（面向用户：如何配置商品并使用话术生成功能）

1. 启动服务

- 本地开发（PowerShell）：

```powershell
# 激活虚拟环境（根据你的环境调整路径）
. .\.venv\Scripts\Activate.ps1
pip install -r requirements.txt
.venv\Scripts\python app.py
```

- Docker（推荐）：

```powershell
docker compose up --build
```


- 启动后打开页面： [http://127.0.0.1:5000/static/live_sim.html](http://127.0.0.1:5000/static/live_sim.html)

1. 在页面上配置直播与商品（左侧面板）

- 填写“主播名称”和“直播主题”。
- 添加商品行：点击“添加商品”按钮。
- 每个商品需要填写：
  - 商品名称（必填）
  - 商品类型（必选，从下拉中选择：水果/蔬菜/禽蛋肉类/五谷/手工艺/加工食品等）
  - 价格（非必填）：可为空，若填写会在会话中展示价格信息。
  - 单位：从下拉选择如“元/斤”“元/个”等。
  - 类型相关的属性会在“商品属性”区域自动显示（例如产地、品种、甜度、尺寸等）。
    - 属性控件会根据类型自动渲染为文本/下拉/日期等。
    - 编辑属性后通常会在失焦（blur）或 select change 时自动保存到服务器（自动保存会触发一次 `/api/session/product-info` 请求），并同步回会话信息，确保快捷话术能即时使用这些属性。

1. 创建会话

- 配置好至少一个商品（商品名与类型必须有），点击“创建会话”。
- 创建成功后，右侧聊天区会启用，你可以直接输入需求或点击下方的快捷建议按钮生成话术。

1. 使用快捷建议与聊天

- 快捷按钮会根据当前会话中第一个商品的类型动态调整文案（例如“产品介绍”“食用方法”等）。
- 快捷键：Alt+1..Alt+5 可快速触发对应建议。
- 发送聊天后若模型提示需要补充信息，前端默认静默处理并基于现有信息继续回答；若你希望更准确的回答，请在左侧表单补充缺失字段，前端会自动保存并刷新会话。

1. 编辑与同步

- 会话创建后，服务端返回的 `products` 会同步回左侧表单（前端会尝试把服务端合并后的 attributes 填回表单）。
- 在表单中修改属性会自动上传到 `/api/session/product-info` 并刷新会话信息。

1. 常见问题与排查

- 如果你填了产地但模型仍然提示缺失：
  - 打开浏览器开发者工具 → Network，检查是否有 `/api/session/product-info` 的请求并返回 200。若没有请求，确认你在属性输入框失焦或 select 改变。
  - 在 Console 中查看是否有 `缺失字段` 的警告或 `保存商品信息失败` 的日志。前端现已将 need_info 的可视提示改为静默记录到控制台以减少干扰。
- 若聊天没有语音（TTS）：确认环境变量 `BAIDU_TTS_API_KEY` 与 `BAIDU_TTS_SECRET_KEY` 是否配置，或检查后端日志。

1. 相关 API（调试与集成用）

- `POST /api/session` — 创建会话（提交 `host_name`, `live_theme`, `products` 列表）
- `GET /api/session/<id>` — 查询会话信息（包括服务端合并的 products）
- `POST /api/chat` — 发送聊天消息并获取 AI 回复
- `POST /api/session/product-info` — 保存单个商品的属性（用于自动保存）

环境变量（最小）

- `SECRET_KEY`, `DEBUG`
- `DB_HOST`, `DB_USER`, `DB_PASSWORD`, `DB_NAME`（或使用内置 SQLite）
- 可选：`BAIDU_TTS_API_KEY`, `BAIDU_TTS_SECRET_KEY`（启用语音）
